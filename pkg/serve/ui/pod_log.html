<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="node_modules/@xterm/xterm/css/xterm.css" />
    <script src="node_modules/@xterm/xterm/lib/xterm.js"></script>
    <script src="node_modules/@xterm/addon-fit/lib/addon-fit.js"></script>
    <script src="./term.js"></script>
    <title>查看日志</title>
</head>

<body>
    <div style="margin: 8;padding: 0;">
        <span>Namespace: <input name="namespace" type="text" value="default" /></span>
        <span>PodName: <input name="pod_name" type="text" value="nginx-7854ff8877-6wg2h" /></span>
        <span>Container Name: <input name="container_name" type="text" value="nginx" /></span>
        <span><button onclick="connect()" id="connect">确认</button></span>
    </div>
    <div id="terminal" style="height: 95vh;"></div>
</body>
<script>
    var term = new Terminal({
        theme: {
            foreground: '#F8F8F8',
            background: '#2D2E2C',
            cursor: "help",
            lineHeight: 10,
        },
        fountSize: 10,
        convertEol: true,
        DisableStdin: false
    });
    term.open(document.getElementById('terminal'));
    // 配置终端
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon)
    fitAddon.fit();
    // function sendRowsAndCols(ws) {
    //     const dimensions = {
    //         rows: term.rows,
    //         cols: term.cols
    //     }
    //     ws.send(JSON.stringify(dimensions))
    // }

    const connBtn = document.getElementById('connect')
    const connect = () => {
        // 连接websocket服务器
        let socket = new WebSocket(`ws://127.0.0.1:9200/ws/pod/terminal/log`)

        // 建立连接后发送请求
        const inputs = document.getElementsByTagName('input')
        const namespace = inputs['namespace'].value
        const pod_name = inputs['pod_name'].value
        const container_name = inputs['container_name'].value
        window.onresize = function () {
            fitAddon.fit();
            // sendRowsAndCols(socket);
        }
        socket.onopen = function (e) {
            socket.send(JSON.stringify({
                namespace: namespace,
                pod_name: pod_name,
                container_name: container_name
            }))
        }
        // 服务端有数据时，把数据写到界面上
        socket.onmessage = function (event) {
            // 判断数据是二进制还是其他
            if (event.data instanceof Blob) {
                // 二进制数据
                let reader = new FileReader();
                reader.onload = e => {
                    term.write(e.target.result)
                }
                reader.readAsText(event.data)
            } else {
                // 文本指令
                console.log(event.data)
            }
        }
        // 关闭时 打印一些日志
        socket.onclose = function (event) {
            console.log(event)
            if (event.wasClean) {
                term.write(`[close] Connection`)
            } else {
                term.write(`[Close] Connection died`)
            }
        }
        // 报错时 也打印一些入职
        socket.onerror = function (error) {
            term.write(`[error]`)
        }
        connBtn.disabled = true
    }

</script>

</html>